#include "keyboard.h"
#include "keydefs.h"

static unsigned int scantokey[128] =
{
	0,
	27,
	49,
	50,
	51,
	52,
	53,
	54,
	55,
	56,
	57,
	48,
	45,
	61,
	256,
	9,
	113,
	119,
	101,
	114,
	116,
	121,
	117,
	105,
	111,
	112,
	91,
	93,
	13,
	263,
	97,
	115,
	100,
	102,
	103,
	104,
	106,
	107,
	108,
	59,
	39,
	96,
	265,
	92,
	122,
	120,
	99,
	118,
	98,
	110,
	109,
	44,
	46,
	47,
	266,
	300,
	261,
	32,
	0,
	267,
	268,
	269,
	270,
	271,
	272,
	273,
	274,
	275,
	276,
	337,
	0,
	285,
	286,
	287,
	298,
	288,
	289,
	290,
	299,
	291,
	292,
	293,
	295,
	296,
	0,
	0,
	0,
	277,
	278,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0
};

static unsigned int scantokeyfr[128] =
{
	0,
	27,
	38,
	233,
	34,
	39,
	40,
	45,
	232,
	95,
	231,
	224,
	41,
	61,
	256,
	9,
	97,
	122,
	101,
	114,
	116,
	121,
	117,
	105,
	111,
	112,
	94,
	36,
	13,
	263,
	113,
	115,
	100,
	102,
	103,
	104,
	106,
	107,
	108,
	109,
	249,
	178,
	265,
	42,
	119,
	120,
	99,
	118,
	98,
	110,
	44,
	59,
	58,
	33,
	266,
	300,
	261,
	32,
	0,
	267,
	268,
	269,
	270,
	271,
	272,
	273,
	274,
	275,
	276,
	337,
	0,
	285,
	286,
	287,
	298,
	288,
	289,
	290,
	299,
	291,
	292,
	293,
	295,
	296,
	0,
	0,
	60,
	277,
	278,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0
};

static unsigned int scantokeyde[128] =
{
	0,
	27,
	49,
	50,
	51,
	52,
	53,
	54,
	55,
	56,
	57,
	48,
	223,
	180,
	256,
	9,
	113,
	119,
	101,
	114,
	116,
	122,
	117,
	105,
	111,
	112,
	252,
	43,
	13,
	263,
	97,
	115,
	100,
	102,
	103,
	104,
	106,
	107,
	108,
	246,
	228,
	94,
	265,
	35,
	121,
	120,
	99,
	118,
	98,
	110,
	109,
	44,
	46,
	45,
	266,
	300,
	261,
	32,
	0,
	267,
	268,
	269,
	270,
	271,
	272,
	273,
	274,
	275,
	276,
	337,
	0,
	285,
	286,
	287,
	298,
	288,
	289,
	290,
	299,
	291,
	292,
	293,
	295,
	296,
	0,
	0,
	60,
	277,
	278,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0
};

static unsigned int scantokeyit[128] =
{
	0,
	27,
	49,
	50,
	51,
	52,
	53,
	54,
	55,
	56,
	57,
	48,
	39,
	236,
	256,
	9,
	113,
	119,
	101,
	114,
	116,
	121,
	117,
	105,
	111,
	112,
	232,
	43,
	13,
	263,
	97,
	115,
	100,
	102,
	103,
	104,
	106,
	107,
	108,
	242,
	224,
	92,
	265,
	249,
	122,
	120,
	99,
	118,
	98,
	110,
	109,
	44,
	46,
	45,
	266,
	300,
	261,
	32,
	0,
	267,
	268,
	269,
	270,
	271,
	272,
	273,
	274,
	275,
	276,
	337,
	0,
	285,
	286,
	287,
	298,
	288,
	289,
	290,
	299,
	291,
	292,
	293,
	295,
	296,
	0,
	0,
	60,
	277,
	278,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0
};

static unsigned int scantokeynl[128] =
{
	0,
	27,
	49,
	50,
	51,
	52,
	53,
	54,
	55,
	56,
	57,
	48,
	47,
	176,
	256,
	9,
	113,
	119,
	101,
	114,
	116,
	121,
	117,
	105,
	111,
	112,
	168,
	42,
	13,
	263,
	97,
	115,
	100,
	102,
	103,
	104,
	106,
	107,
	108,
	43,
	180,
	64,
	265,
	60,
	122,
	120,
	99,
	118,
	98,
	110,
	109,
	44,
	46,
	45,
	266,
	300,
	261,
	32,
	0,
	267,
	268,
	269,
	270,
	271,
	272,
	273,
	274,
	275,
	276,
	337,
	0,
	285,
	286,
	287,
	298,
	288,
	289,
	290,
	299,
	291,
	292,
	293,
	295,
	296,
	0,
	0,
	93,
	277,
	278,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0
};

static unsigned int scantokeysv[128] =
{
	0,
	27,
	49,
	50,
	51,
	52,
	53,
	54,
	55,
	56,
	57,
	48,
	43,
	180,
	256,
	9,
	113,
	119,
	101,
	114,
	116,
	121,
	117,
	105,
	111,
	112,
	229,
	168,
	13,
	263,
	97,
	115,
	100,
	102,
	103,
	104,
	106,
	107,
	108,
	246,
	228,
	167,
	265,
	39,
	122,
	120,
	99,
	118,
	98,
	110,
	109,
	44,
	46,
	45,
	266,
	300,
	261,
	32,
	0,
	267,
	268,
	269,
	270,
	271,
	272,
	273,
	274,
	275,
	276,
	337,
	0,
	285,
	286,
	287,
	298,
	288,
	289,
	290,
	299,
	291,
	292,
	293,
	295,
	296,
	0,
	0,
	60,
	277,
	278,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0
};

static unsigned int scantokeyes[128] =
{
	0,
	27,
	49,
	50,
	51,
	52,
	53,
	54,
	55,
	56,
	57,
	48,
	39,
	161,
	256,
	9,
	113,
	119,
	101,
	114,
	116,
	121,
	117,
	105,
	111,
	112,
	96,
	43,
	13,
	263,
	97,
	115,
	100,
	102,
	103,
	104,
	106,
	107,
	108,
	241,
	180,
	186,
	265,
	231,
	122,
	120,
	99,
	118,
	98,
	110,
	109,
	44,
	46,
	45,
	266,
	300,
	261,
	32,
	0,
	267,
	268,
	269,
	270,
	271,
	272,
	273,
	274,
	275,
	276,
	337,
	0,
	285,
	286,
	287,
	298,
	288,
	289,
	290,
	299,
	291,
	292,
	293,
	295,
	296,
	0,
	0,
	60,
	277,
	278,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0
};

static unsigned int scantokey2[128] =
{
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	294,
	264,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	297,
	0,
	0,
	262,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	283,
	257,
	282,
	0,
	259,
	0,
	260,
	0,
	284,
	258,
	281,
	279,
	280,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0
};

unsigned int* KeyboardLayout;
char* Languages[8] = { "EN", "FR", "DE", "IT", "NL", "SV", "ES", NULL };
unsigned int* KeyboardLayouts[8] = { scantokey, scantokeyfr, scantokeyde, scantokeyit, scantokeynl, scantokeysv, scantokeyes, scantokey };

BOOLEAN SetKeyboardLayout(char* region)
{
	if (region)
	{
		for (int i = 0; i < 8; i++)
		{
			if (!_stricmp(region, Languages[i]))
			{
				KeyboardLayout = KeyboardLayouts[i];
				return TRUE;
			}
		}
	}
	KeyboardLayout = KeyboardLayouts[0];
	return FALSE;
}

//#define sub_401170(a) MapKey(a)
#define BYTEn(width, n)   (*((char*)&(width)+n))
#define BYTE1(width)   BYTEn(width,  1)         // byte 1 (counting from 0)
int MapKey(int key)
{
	signed int modified; // ecx@1
	bool v2; // dl@3
	int result; // eax@6

	modified = (key >> 16);
	v2 = KeyboardLayout != /*&*/KeyboardLayouts[0] && BYTE1(modified) & 0x20;
	modified = (unsigned __int8)modified;

	if ((signed int)(unsigned __int8)modified <= 127)
	{
		if (v2 && modified == VK_NONCONVERT)
		{
			result = 262;
		}
		else if (((unsigned int)(key >> 16) >> 8) & 1)
		{
			result = scantokey2[modified];
		}
		else
		{
			result = KeyboardLayout[modified]; //*((DWORD *)KeyboardLayout + modified);
		}
	}
	else
	{
		result = 0; //186 supposed ot result 96
	}

	return result;
}